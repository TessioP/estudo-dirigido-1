\section{Expansion of Maxwell's Curl Equations in Cartesian Coordinates}

The Maxwell's equations are:

\begin{eqnarray}
    \rot \Et(t) = & -\partial _t \Bt(t), \\
    \rot \Hht(t) = & \partial_t \Dt(t), \\
    \Div \Bt(t) = & 0, \\
    \Div \Dt(t) = & 0,
\end{eqnarray}
where $\partial_t\cdot = \partialDerivative{\cdot}{t}$.

The the constitutive relations are:
\begin{eqnarray}
    \Bt(t) = & \brackets{\mu_0\mu_r  (t)} \ast \Hht(t), \\
    \Dt(t) = & \brackets{\epsilon_0 \epsilon_r  (t)} \ast \Et(t),
\end{eqnarray}
where $\brackets{\cdot}$ represents a tensor.

\subsection{Normalizing the Electric Fields}
It will be adopted the conventional approach in FDTD and the electric field will be normalized as:
\begin{equation}
    \tilde{\Et}(t) = \sqrt{\cfrac{\epsilon_0}{\mu_0}}\Et(t) = \cfrac{1}{\eta_0}\Et(t).
\end{equation}
Also, from now on, the time depency $(t)$ will be ommited for cleaning notation reasons.

The other parameters related to the electric field must also be normalized:
\begin{equation}
    \tilde{\Dt} = \sqrt{\cfrac{1}{\epsilon_0\mu_0}} \Dt = c_0 \Dt.
\end{equation}

Therefore, the normalized Maxwell's equations become:

\begin{eqnarray}
    \rot \En = & -\partial _t \Bt, \\
    \rot \Hht = & \partial_t \Dn, \\
    \Div \Bt = & 0, \\
    \Div \Dn = & 0.
\end{eqnarray}


\subsection{Expanding Maxwell's Equations}

To expand the equations, it will be assumed that $\brackets{\mu_r}$ and $\brackets{\epsilon_r}$ has only diagonal terms \cite{rumpf_book}. 

The equation $\rot \En = - \cfrac{\brackets{\mu_r}}{c_0} \partial _t \Bt$ becomes:

\begin{eqnarray}
    \partial_z\En_y - \partial_y\En_z =& \cfrac{\mu_{xx}}{c_0} \partial_t \Hht_x, \\
    \partial_x\En_z - \partial_z\En_x =& \cfrac{\mu_{yy}}{c_0} \partial_t \Hht_y,\\
    \partial_y\En_x - \partial_x\En_y =& \cfrac{\mu_{zz}}{c_0} \partial_t \Hht_z.
\end{eqnarray}

The equation $\rot \Hht = \cfrac{1}{c_0} \partial _t \Dn$ becomes:

\begin{eqnarray}
    \partial_z\Hht_y - \partial_y\Hht_z =& \cfrac{1}{c_0} \partial_t \Dn_x, \\
    \partial_x\Hht_z - \partial_z\Hht_x =& \cfrac{1}{c_0} \partial_t \Dn_y, \\
    \partial_y\Hht_x - \partial_x\Hht_y =& \cfrac{1}{c_0} \partial_t \Dn_z.
\end{eqnarray}

Finally, the equation $ \Dn = \brackets{\epsilon_r} \En $ becomes:

\begin{eqnarray}
    \Dn_x =& \epsilon_{xx} \En_x, \label{eq:Dn_x}\\
    \Dn_y =& \epsilon_{yy} \En_y, \label{eq:Dn_y}\\
    \Dn_z =& \epsilon_{zz} \En_z. \label{eq:Dn_z}
\end{eqnarray}

\subsection{Notation for Curl Terms}

\begin{eqnarray}
    \CEx =& \partial_z\En_y - \partial_y\En_z, \\
    \CEy =& \partial_x\En_z - \partial_z\En_x, \\
    \CEz =& \partial_y\En_x - \partial_x\En_y.
\end{eqnarray}

\begin{eqnarray}
    \CHx =& \partial_z\Hht_y - \partial_y\Hht_z, \\
    \CHy =& \partial_x\Hht_z - \partial_z\Hht_x, \\
    \CHz =& \partial_y\Hht_x - \partial_x\Hht_y.
\end{eqnarray}

\subsection{Final Equations Form}

\begin{eqnarray}
    \CEx =& \cfrac{\mu_{xx}}{c_0} \partial_t \Hht_x, \\
    \CEy =& \cfrac{\mu_{yy}}{c_0} \partial_t \Hht_y,\\
    \CEz =& \cfrac{\mu_{zz}}{c_0} \partial_t \Hht_z.
\end{eqnarray}

\begin{eqnarray}
    \CHx =& \cfrac{1}{c_0} \partial_t \Dn_x, \\
    \CHy =& \cfrac{1}{c_0} \partial_t \Dn_y, \\
    \CHz =& \cfrac{1}{c_0} \partial_t \Dn_z.
\end{eqnarray}

\begin{eqnarray}
    \Dn_x =& \epsilon_{xx} \En_x, \\
    \Dn_y =& \epsilon_{yy} \En_y, \\
    \Dn_z =& \epsilon_{zz} \En_z.
\end{eqnarray}


\section{Finite-Difference Approximation to Maxwell's Equations}

\subsection{Yee Grid}
A unit cell is constructed by dividing the 3 axis into discrete cells of size $(\dx, \dy, \dz)$. Inside this cell, it is necessary to put all the fields of the electromagnetic problem $(\Et_x, \Et_y, \Et_z, \Hht_x, \Hht_x, \Hht_z)$. Instead of putting all fields on the origin $(0, 0, 0)$, where is more intuitive, Yee proposed the following approach:

\input{contents/tiks/yee_grid.tex}

\begin{itemize}
    \item $\Et_x$ on $(\dx/2, 0, 0)$,
    \item $\Et_y$ on $(0, \dy/2, 0)$,
    \item $\Et_z$ on $(0, 0, \dz/2)$,
    \item $\Hht_x$ on $(0, \dy/2, \dz/2)$,
    \item $\Hht_y$ on $(\dx/2, 0, \dz/2)$,
    \item $\Hht_z$ on $(\dx/2, \dy/2, 0)$.
\end{itemize}

There are some reasons for using this scheme:
\begin{itemize}
    \item The divergences are naturally zero.
    \item The physical boundary conditions are naturally satisfied.
    \item It is an elegant arrangement to approximate Maxwell's curl equations.
\end{itemize}

Additionaly, there are some consequences for using this scheme:
\begin{itemize}
    \item Field components are in physically different locations.
    \item Field components may be in different materials even if they are in the same unit cell.
    \item Field components will be out of phase.
\end{itemize}

\subsection{Finite-Difference Equations on Yee Grid}

Each cell on the grid is identified by the coordines $(i\dx, j\dy, k\dz)$, where $(i, j, k)$ are the index of the cell.

Note that on each face of the Yee cell there is the fields of the adjacent cell.

Consider, first, the grid for $\Hht_x$:

\input{contents/tiks/yee_grid_chx.tex}

Based on this schematic, it is possible to write \cite{rumpf_book}:

\begin{eqnarray}
    \partialDerivative{\En_z^{i,j,k}}{y}(t) =& \cfrac{\En_z^{i, j+1, k}(t)-\En_z^{i, j, k}(t)}{\dy}, \\
    \partialDerivative{\En_y^{i,j,k}}{z}(t) =& \cfrac{\En_y^{i, j, k+1}(t)-\En_y^{i, j, k}(t)}{\dy}.
\end{eqnarray}

Note that this space derivatives exists at time instant $t$ and they exist at the same point as $\Hht_x^{i,j,k}$.

We need to explicitly write the time on the Yee grid equations, since it is essencial to write all the members of equations on the same time instant.

Hence, the $\CEx$ final equation is:

\begin{eqnarray}
    \CEx =& \cfrac{\En_z^{i, j+1, k}(t)-\En_z^{i, j, k}(t)}{\dy} - \nonumber \\ 
    \qquad & \cfrac{\En_y^{i, j, k+1}(t)-\En_y^{i, j, k}(t)}{\dz}
    \label{eq:CEx}
\end{eqnarray}

Now, for the time derivative $\partial_t \Hht_x$ to exists at time $t$:

\begin{equation}
    \partial_t \Hht_x^{i,j,k}(t) = \cfrac{\Hht_x^{i,j,k}(t+\nicefrac{\dt}{2}) - \Hht_x^{i,j,k}(t-\nicefrac{\dt}{2})}{\dt}.
\end{equation}

So, the finite-difference equation for $\Hht_x$ becomes:

\begin{eqnarray}
    \cfrac{\En_z^{i, j+1, k}(t)-\En_z^{i, j, k}(t)}{\dy} - \cfrac{\En_y^{i, j, k+1}(t)-\En_y^{i, j, k}(t)}{\dy} \nonumber \\ 
    =\cfrac{\mu_{xx}^{i,j,k}}{c_0}\cfrac{\Hht_x^{i,j,k}(t+\nicefrac{\dt}{2}) - \Hht_x^{i,j,k}(t-\nicefrac{\dt}{2})}{\dt}.
    \label{eq:fd_hx}
\end{eqnarray}

Similarly, it is possible to write the curl equations for the other components of $\En$ and for $\Hht$:

\begin{eqnarray}
    \CEy =& \cfrac{\En_x^{i, j, k+1}(t)-\En_x^{i, j, k}(t)}{\dz} - \nonumber \\ 
    \qquad & \cfrac{\En_z^{i+1, j, k}(t)-\En_z^{i, j, k}(t)}{\dx}
    \label{eq:CEy}
\end{eqnarray}

\begin{eqnarray}
    \CEz =& \cfrac{\En_y^{i+1, j, k}(t)-\En_y^{i, j, k}(t)}{\dx} - \nonumber \\ 
    \qquad & \cfrac{\En_x^{i, j+1, k}(t)-\En_x^{i, j+1, k}(t)}{\dy}
    \label{eq:CEz}
\end{eqnarray}

\begin{eqnarray}
    \CHx =& \cfrac{\Hht_z^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_z^{i, j-1, k}(t+\nicefrac{\dt}{2})}{\dy} - \nonumber \\ 
    \qquad & \cfrac{\Hht_y^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_y^{i, j, k-1}(t+\nicefrac{\dt}{2})}{\dz}
    \label{eq:CHx}
\end{eqnarray}


\begin{eqnarray}
    \CHy =& \cfrac{\Hht_x^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_x^{i, j, k-1}(t+\nicefrac{\dt}{2})}{\dz} - \nonumber \\ 
    \qquad & \cfrac{\Hht_z^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_z^{i-1, j, k}(t+\nicefrac{\dt}{2})}{\dx}
    \label{eq:CHy}
\end{eqnarray}


\begin{eqnarray}
    \CHz =& \cfrac{\Hht_y^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_y^{i-1, j, k}(t+\nicefrac{\dt}{2})}{\dx} - \nonumber \\ 
    \qquad & \cfrac{\Hht_x^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_x^{i, j-1, k}(t+\nicefrac{\dt}{2})}{\dy}
    \label{eq:CHz}
\end{eqnarray}

Finally, the finite-difference equations are, for $\Hht_y$:

\begin{eqnarray}
    \cfrac{\En_x^{i, j, k+1}(t)-\En_x^{i, j, k}(t)}{\dz} - \cfrac{\En_z^{i+1, j, k}(t)-\En_z^{i, j, k}(t)}{\dx} \nonumber \\ 
    =\cfrac{\mu_{yy}^{i,j,k}}{c_0}\cfrac{\Hht_y^{i,j,k}(t+\nicefrac{\dt}{2}) - \Hht_y^{i,j,k}(t-\nicefrac{\dt}{2})}{\dt},
    \label{eq:fd_hy}
\end{eqnarray}

for $\Hht_z$:

\begin{eqnarray}
    \cfrac{\En_y^{i+1, j, k}(t)-\En_y^{i, j, k}(t)}{\dx} - \cfrac{\En_x^{i, j+1, k}(t)-\En_x^{i, j+1, k}(t)}{\dy} \nonumber \\
    =\cfrac{\mu_{zz}^{i,j,k}}{c_0}\cfrac{\Hht_z^{i,j,k}(t+\nicefrac{\dt}{2}) - \Hht_z^{i,j,k}(t-\nicefrac{\dt}{2})}{\dt},
    \label{eq:fd_hz}
\end{eqnarray}

for $\En_x$:

\begin{eqnarray}
    &\cfrac{\Hht_z^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_z^{i, j-1, k}(t+\nicefrac{\dt}{2})}{\dy} - \nonumber\\ 
    & \cfrac{\Hht_y^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_y^{i, j, k-1}(t+\nicefrac{\dt}{2})}{\dz} = \nonumber\\
    &\cfrac{\epsilon_{xx}^{i,j,k}}{c_0}\cfrac{\En_x^{i,j,k}(t+\nicefrac{\dt}{2})-\En_x^{i,j,k}(t)}{\dt},
    \label{eq:fd_ex}
\end{eqnarray}

for $\En_y$:

\begin{eqnarray}
    &\cfrac{\Hht_x^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_x^{i, j, k-1}(t+\nicefrac{\dt}{2})}{\dz} - \nonumber \\
    &\cfrac{\Hht_z^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_z^{i-1, j, k}(t+\nicefrac{\dt}{2})}{\dx} = \nonumber\\
    &\cfrac{\epsilon_{yy}^{i,j,k}}{c_0}\cfrac{\En_y^{i,j,k}(t+\nicefrac{\dt}{2})-\En_y^{i,j,k}(t)}{\dt},
    \label{eq:fd_ey}
\end{eqnarray}

and for $\En_z$:

\begin{eqnarray}
    &\cfrac{\Hht_y^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_y^{i-1, j, k}(t+\nicefrac{\dt}{2})}{\dx} - \nonumber \\ 
    & \cfrac{\Hht_x^{i, j, k}(t+\nicefrac{\dt}{2})-\Hht_x^{i, j-1, k}(t+\nicefrac{\dt}{2})}{\dy} = \nonumber\\
    &\cfrac{\epsilon_{zz}^{i,j,k}}{c_0}\cfrac{\En_z^{i,j,k}(t+\nicefrac{\dt}{2})-\En_z^{i,j,k}(t)}{\dt}.
    \label{eq:fd_ez}
\end{eqnarray}


To ease the implementation, the vector $\En$ will exists at integer step times $(0, \dt, 2\dt, \dots)$ meanwhile the vector $\Hht$ will exists at half time steps $(\nicefrac{\dt}{2}, 3\nicefrac{\dt}{2}, 5\nicefrac{\dt}{2}, \dots)$.

\section{The Perfect Matching Layer}

The tensors for the permittivity and permeability will be \cite{rumpf_book}:

\begin{equation}
    \brackets{\epsilon_{r,x}} = \brackets{\mu_{r,x}} = \begin{bmatrix}
        \cfrac{1}{s_x} & 0 & 0 \\
        0 & s_x & 0 \\
        0 & 0 & s_x
    \end{bmatrix},
\end{equation}
for a wave travelling at $x$ direction,

\begin{equation}
    \brackets{\epsilon_{r,y}} = \brackets{\mu_{r,y}} = \begin{bmatrix}
        s_y & 0 & 0 \\
        0 & \cfrac{1}{s_y} & 0 \\
        0 & 0 & s_y
    \end{bmatrix},
\end{equation}
for a wave travelling at $y$ direction, and

\begin{equation}
    \brackets{\epsilon_{r,z}} = \brackets{\mu_{r,z}} = \begin{bmatrix}
        s_z & 0 & 0 \\
        0 & s_z & 0 \\
        0 & 0 & \cfrac{1}{s_z}
    \end{bmatrix},
\end{equation}
for a wave travelling at $z$ direction.

And, for absorb all waves in all boundaries,

\begin{equation}
    \brackets{\epsilon_{r,\textnormal{UPML}}} = \brackets{\mu_{r,\textnormal{UPML}}} = \brackets{S} = \brackets{\epsilon_{r,x}}\brackets{\epsilon_{r,y}}\brackets{\epsilon_{r,z}} \nonumber
\end{equation} 
\begin{equation}
    \brackets{S} = \begin{bmatrix}
        \cfrac{s_ys_z}{s_x} & 0 & 0 \\
        0 & \cfrac{s_xs_z}{s_y} & 0 \\
        0 & 0 & \cfrac{s_xs_y}{s_z}
    \end{bmatrix}.
\end{equation}

The loss is incorporated into the permittivity through the electrical conductivity $\sigma$ as $\tilde{\epsilon} = \epsilon_r + \cfrac{\sigma}{j\omega \epsilon_0}$.

\subsection{Incorporating PML into Maxwell's Equations}

The Maxwell's Equations in the frequency domain are:

\begin{eqnarray}
    \rot \E (\omega) =& -j\omega \mu_0 \brackets{\mu_r} \Hh (\omega) \\
    \rot \Hh (\omega) =& \sigma \E(\omega) + j\omega\brackets{S} \D (\omega) \\
    \D (\omega) =& \epsilon_0 \brackets{\epsilon _r}\E (\omega)
\end{eqnarray}

The PML $\brackets{S}$ can be incorporated as:

\begin{eqnarray}
    \rot \E (\omega) =& -j\omega \mu_0 \brackets{\mu_r} \brackets{S} \Hh (\omega) \\
    \rot \Hh (\omega) =& \sigma \E(\omega) + j\omega \D (\omega) \\
    \D (\omega) =& \epsilon_0 \brackets{\epsilon _r} \E (\omega)
\end{eqnarray}

Normalizing the electric field:

\begin{equation}
    \tilde{\E}(\omega) = \sqrt{\cfrac{\epsilon_0}{\mu_0}}\E(\omega) = \cfrac{1}{\eta_0}\E(\omega)
\end{equation}

\begin{equation}
    \tilde{\D}(\omega) = \sqrt{\cfrac{1}{\epsilon_0\mu_0}} \D(\omega) = c_0 \D(\omega)
\end{equation}

Hence, the equations become:

\begin{eqnarray}
    \rot \Enw (\omega) =& -j\omega\cfrac{\brackets{\mu_r}}{c_0} \brackets{S} \Hh (\omega) \\
    \rot \Hh (\omega) =& \eta_0 \sigma \Enw(\omega) + \cfrac{j\omega}{c_0}\brackets{S} \Dnw (\omega) \\
    \D (\omega) =& \brackets{\epsilon _r} \Enw (\omega)
\end{eqnarray}

Keeping $\brackets{S}$ separate from $\brackets{\mu_r}$ and $\brackets{\epsilon_r}$ allows the PML to be handled independently from the materials being simulated.

The $\omega$ will be ommitted from the equations.

Considering only the diagonal terms in $\brackets{\mu_r}$, $\brackets{\epsilon_r}$ and $\brackets{\sigma}$, the final form of the Maxwell's Equations with UPML are \cite{empossible_3d_pml}:

\begin{eqnarray}
    &j\omega\pare{1 + \cfrac{\sigma_x\Prime}{j\omega\epsilon_0}}\inverse \pare{1 + \cfrac{\sigma_y\Prime}{j\omega\epsilon_0}}\pare{1 + \cfrac{\sigma_z\Prime}{j\omega\epsilon_0}} \Hh_x \nonumber \\
    &= -\cfrac{c_0}{\mu_{xx}}\CExw
    \label{eq:Hx_upml_freq}
\end{eqnarray}

\begin{eqnarray}
    &j\omega\pare{1 + \cfrac{\sigma_x\Prime}{j\omega\epsilon_0}} \pare{1 + \cfrac{\sigma_y\Prime}{j\omega\epsilon_0}}\inverse\pare{1 + \cfrac{\sigma_z\Prime}{j\omega\epsilon_0}} \Hh_y \nonumber \\
    &= -\cfrac{c_0}{\mu_{yy}}\CEyw
    \label{eq:Hy_upml_freq}
\end{eqnarray}

\begin{eqnarray}
    &j\omega\pare{1 + \cfrac{\sigma_x\Prime}{j\omega\epsilon_0}} \pare{1 + \cfrac{\sigma_y\Prime}{j\omega\epsilon_0}}\pare{1 + \cfrac{\sigma_z\Prime}{j\omega\epsilon_0}}\inverse \Hh_z \nonumber \\
    &= -\cfrac{c_0}{\mu_{zz}}\CEzw
    \label{eq:Hz_upml_freq}
\end{eqnarray}

\begin{eqnarray}
    &j\omega\pare{1 + \cfrac{\sigma_x\Prime}{j\omega\epsilon_0}}\inverse \pare{1 + \cfrac{\sigma_y\Prime}{j\omega\epsilon_0}}\pare{1 + \cfrac{\sigma_z\Prime}{j\omega\epsilon_0}} \Dnw_x \nonumber \\
    &= c_0\CHxw - \cfrac{\sigma_{xx}}{\epsilon_0}\Enw_x
    \label{eq:Ex_upml_freq}
\end{eqnarray}

\begin{eqnarray}
    &j\omega\pare{1 + \cfrac{\sigma_x\Prime}{j\omega\epsilon_0}} \pare{1 + \cfrac{\sigma_y\Prime}{j\omega\epsilon_0}}\inverse \pare{1 + \cfrac{\sigma_z\Prime}{j\omega\epsilon_0}} \Dnw_y \nonumber \\
    &= c_0\CHyw - \cfrac{\sigma_{yy}}{\epsilon_0}\Enw_y
    \label{eq:Ey_upml_freq}
\end{eqnarray}

\begin{eqnarray}
    &j\omega\pare{1 + \cfrac{\sigma_x\Prime}{j\omega\epsilon_0}} \pare{1 + \cfrac{\sigma_y\Prime}{j\omega\epsilon_0}} \pare{1 + \cfrac{\sigma_z\Prime}{j\omega\epsilon_0}}\inverse \Dnw_z \nonumber \\
    &= c_0\CHzw - \cfrac{\sigma_{zz}}{\epsilon_0}\Enw_z
    \label{eq:Ez_upml_freq}
\end{eqnarray}

\begin{eqnarray}
    \Dnw_x =& \epsilon_{xx} \Enw_x, \\
    \Dnw_y =& \epsilon_{yy} \Enw_y, \\
    \Dnw_z =& \epsilon_{zz} \Enw_z. 
\end{eqnarray}

\subsection{Conversion to the Time-Domain}
First, assume no conductivity: $\brackets{\sigma} = 0$.

Starting from \eqref{eq:Hx_upml_freq}:


\begin{eqnarray}
    j\omega \Hh_x + \cfrac{\sigma_y\Prime + \sigma_z\Prime}{\epsilon_0}\Hh_x + \cfrac{1}{j\omega}\cfrac{\sigma_y\Prime\sigma_z\Prime}{\epsilon_0^2}\Hh_x \nonumber \\
    = -\cfrac{c_0}{\mu_{xx}}\CExw - \cfrac{1}{j\omega}\cfrac{c_0\sigma_x\Prime}{\epsilon_0\mu_{xx}}\CExw
\end{eqnarray}

In the time-domain becomes:

\begin{eqnarray}
    \partial_t\Hht_x + \cfrac{\sigma_y\Prime + \sigma_z\Prime}{\epsilon_0}\Hht_x + \int\limits_{-\infty}^t\cfrac{\sigma_y\Prime\sigma_z\Prime}{\epsilon_0^2}\Hht_x(\tau)d\tau \nonumber \\
    = -\cfrac{c_0}{\mu_{xx}}\CEx - \int\limits_{\infty}^t\cfrac{c_0\sigma_x\Prime}{\epsilon_0\mu_{xx}}\CEx(\tau)d\tau
    \label{eq:Hx_upml_time}
\end{eqnarray}

Similarly, for the other components:

\begin{eqnarray}
    \partial_t\Hht_y + \cfrac{\sigma_x\Prime + \sigma_z\Prime}{\epsilon_0}\Hht_y + \int\limits_{-\infty}^t\cfrac{\sigma_x\Prime\sigma_z\Prime}{\epsilon_0^2}\Hht_y(\tau)d\tau \nonumber \\
    = -\cfrac{c_0}{\mu_{yy}}\CEy - \int\limits_{\infty}^t\cfrac{c_0\sigma_y\Prime}{\epsilon_0\mu_{yy}}\CEy(\tau)d\tau
    \label{eq:Hy_upml_time}
\end{eqnarray}

\begin{eqnarray}
    \partial_t\Hht_z + \cfrac{\sigma_x\Prime + \sigma_y\Prime}{\epsilon_0}\Hht_z + \int\limits_{-\infty}^t\cfrac{\sigma_x\Prime\sigma_y\Prime}{\epsilon_0^2}\Hht_z(\tau)d\tau \nonumber \\
    = -\cfrac{c_0}{\mu_{zz}}\CEz - \int\limits_{\infty}^t\cfrac{c_0\sigma_z\Prime}{\epsilon_0\mu_{zz}}\CEz(\tau)d\tau
    \label{eq:Hz_upml_time}
\end{eqnarray}

\subsection{Numerical Approximations}

Remark: for numerical implementation, Yee Grid will be used.

Starting from \eqref{eq:Hx_upml_time}, each term of equation will be approximated as shown.

For the term 1, the time approximation will be the same as used before:

\begin{eqnarray}
    \partial_t\Hht_x(t) \approx \cfrac{\Hht_x\Big|_{(t+\nicefrac{\dt}{2})}^{i,j,k}-\Hht_x\Big|^{i,j,k}_{(t-\nicefrac{\dt}{2})}}{\dt}
\end{eqnarray}

For the term 2, it is necessary to approximate $\Hht_x(t)$, that will be done by averaging the values at $t + \nicefrac{\dt}{2}$ and $t - \nicefrac{\dt}{2}$:

\begin{eqnarray}
    \cfrac{\sigma_y\Prime + \sigma_z\Prime}{\epsilon_0}\Hht_x(t)\approx
    \cfrac{\sigma_y\Prime + \sigma_z\Prime}{\epsilon_0}\cfrac{\Hht_x\Big|_{(t+\nicefrac{\dt}{2})}^{i,j,k}+\Hht_x\Big|^{i,j,k}_{(t-\nicefrac{\dt}{2})}}{2}
\end{eqnarray}

For the term 3, it is necessary to approximate the integral with a summation:

\begin{eqnarray}
    \int\limits_{-\infty}^t\cfrac{\sigma_y\Prime\sigma_z\Prime}{\epsilon_0^2}\Hht_x(\tau)d\tau \approx \cfrac{\sigma_y\Prime\sigma_z\Prime}{\epsilon_0^2} \sum_{T=\nicefrac{\dt}{2}}^{t + \nicefrac{\dt}{2}}\Hht_x\Big|^{i,j,k}_{T}\dt
\end{eqnarray}

However, in this way the summation is going future on time. The fix is simple: just pull out the last term from summation and do the integration over half a time step:

\begin{eqnarray}
    &\int\limits_{-\infty}^t\cfrac{\sigma_y\Prime\sigma_z\Prime}{\epsilon_0^2}\Hht_x(\tau)d\tau \nonumber \\ \nonumber
    &\approx \cfrac{\sigma_y\Prime\sigma_z\Prime}{\epsilon_0^2} \left( \Hht_x\Big|_{(t+\nicefrac{\dt}{2})}^{i,j,k} \cfrac{\dt}{2} + \sum\limits_{T=\nicefrac{\dt}{2}}^{t - \nicefrac{\dt}{2}}\Hht_x\Big|^{i,j,k}_{T}\dt \right) \\ \nonumber
    &\approx\cfrac{\sigma_y\Prime\sigma_z\Prime\dt}{\epsilon_0^2} \left( \cfrac{\Hht_x\Big|_{(t+\nicefrac{\dt}{2})}^{i,j,k}-\Hht_x\Big|^{i,j,k}_{(t-\nicefrac{\dt}{2})}}{4} \right. \\ & \left. + \sum\limits_{T=\nicefrac{\dt}{2}}^{t - \nicefrac{\dt}{2}}\Hht_x\Big|^{i,j,k}_{T} \right)
\end{eqnarray}

For the term 4, the curl approximation for will be the same as in \eqref{eq:CEx}:

\begin{eqnarray}
    -\cfrac{c_0}{\mu_{xx}}\CEx \approx -\cfrac{c_0}{\mu_{xx}\Big|^{i,j,k}}\CEx\Big|^{i,j,k}_{t}
\end{eqnarray}

For the term 5, as for the term 3, the integral will be approximated with a summation:

\begin{eqnarray}
    - \int\limits_{\infty}^t\cfrac{c_0\sigma_x\Prime}{\epsilon_0\mu_{xx}}\CEx(\tau)d\tau = - \cfrac{c_0\sigma_x\Prime}{\epsilon_0\mu_{xx}} \int\limits_{\infty}^t\CEx(\tau)d\tau \nonumber \\
    \approx - \cfrac{c_0\sigma_x^H\Big|^{i,j,k}}{\epsilon_0\mu_{xx}\Big|^{i,j,k}} \sum\limits_{T=0}^{t}\CEx\Big|^{i,j,k}_{T}\dt \nonumber \\
    \approx - \cfrac{c_0\dt\sigma_x^H\Big|^{i,j,k}}{\epsilon_0\mu_{xx}\Big|^{i,j,k}} \sum\limits_{T=0}^{t}\CEx\Big|^{i,j,k}_{T}
\end{eqnarray}

\subsection{The PML Parameters}



